<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>market maker</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] { -moz-appearance: textfield; }
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #000000;
            color: #e0e0e0;
            padding: 20px;
            font-size: 14px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2d2d44;
        }
        .balance { color: #9d4edd; font-size: 16px; }

        .controls {
            background: #0a0a0f;
            border: 1px solid #2d2d44;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .controls h3 { margin-bottom: 10px; color: #888; }
        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        .form-group label { color: #888; font-size: 11px; }
        .form-group input {
            background: #000000;
            border: 1px solid #2d2d44;
            color: #e0e0e0;
            padding: 4px 6px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
        }
        .form-group input:focus { outline: none; border-color: #9d4edd; }
        .form-group input.short { width: 60px; }
        .form-group input.medium { width: 280px; }

        button {
            background: #9d4edd;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: bold;
        }
        button:hover { background: #b266ff; }
        button.stop { background: #dc3545; color: #fff; }
        button.stop:hover { background: #e35d6a; }
        button.secondary { background: #2d2d44; color: #e0e0e0; }
        button.secondary:hover { background: #3d3d5c; }
        button.primary { background: #6b5b95; color: #fff; }
        button.primary:hover { background: #7d6ba3; }

        .category-section {
            margin-bottom: 12px;
        }
        .category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #12121a;
            border: 1px solid #2d2d44;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            margin-bottom: 8px;
        }
        .category-header:hover {
            background: #1a1a24;
        }
        .category-toggle {
            color: #888;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .category-header.collapsed .category-toggle {
            transform: rotate(-90deg);
        }
        .category-name {
            color: #9d4edd;
            font-weight: bold;
            font-size: 12px;
        }
        .category-count {
            color: #666;
            font-size: 11px;
        }
        .category-matches {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 8px;
        }
        .category-matches.collapsed {
            display: none;
        }
        .matches {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .match {
            background: #0a0a0f;
            border: 1px solid #2d2d44;
            border-radius: 4px;
            padding: 8px 10px;
            font-size: 12px;
        }
        .match.active { border-color: #9d4edd; }
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .match-title {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .match-name { font-weight: bold; color: #e0e0e0; text-decoration: none; font-size: 11px; }
        .match-name:hover { color: #9d4edd; text-decoration: underline; }
        .missed-trade { margin-left: 8px; font-size: 10px; color: #dc3545; cursor: help; }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #444;
        }
        .status-dot.active { background: #22c55e; }
        .match-actions {
            display: flex;
            gap: 4px;
        }
        .match-actions button { padding: 2px 8px; font-size: 10px; }

        .orderbooks {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 6px;
        }
        .orderbook {
            background: #000000;
            border-radius: 3px;
            padding: 6px;
        }
        .orderbook-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid #2d2d44;
        }
        .orderbook-label { color: #9d4edd; font-weight: bold; font-size: 11px; }
        .orderbook-spread { color: #888; font-weight: normal; }
        .orderbook-theo { color: #888; font-size: 10px; }

        .orderbook-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 2px;
        }
        .orderbook-side { color: #888; width: 24px; }
        .orderbook-best { color: #e0e0e0; }
        .orderbook-our { font-weight: bold; }
        .orderbook-our.active { color: #9d4edd; }
        .orderbook-our.rebal { color: #f59e0b; }
        .orderbook-our.inactive { color: #dc3545; font-style: italic; font-weight: normal; }

        .match-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 6px;
            border-top: 1px solid #2d2d44;
            font-size: 11px;
        }
        .inventory { color: #888; }
        .inventory.overexposed { color: #dc3545; }

        .match-settings {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .setting-group {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .setting-group label {
            color: #666;
            font-size: 10px;
        }
        .setting-group input {
            background: #000;
            border: 1px solid #2d2d44;
            color: #e0e0e0;
            padding: 2px 3px;
            border-radius: 2px;
            font-family: inherit;
            font-size: 10px;
            width: 32px;
            text-align: center;
        }
        .setting-group input:focus {
            outline: none;
            border-color: #9d4edd;
        }
        .setting-group input.wide {
            width: 42px;
        }

        .fills {
            background: #0a0a0f;
            border: 1px solid #2d2d44;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        .fills h3 { margin-bottom: 10px; color: #888; }
        .fill-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .fill {
            padding: 6px 0;
            border-bottom: 1px solid #1a1a24;
            display: flex;
            gap: 15px;
            font-size: 13px;
        }
        .fill:last-child { border-bottom: none; }
        .fill-time { color: #888; }
        .fill-details { color: #e0e0e0; }
        .fill.complete { color: #9d4edd; }

        /* Dashboard items in header */
        .dashboard-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dashboard-item label {
            color: #666;
            font-size: 12px;
        }
        .dashboard-item .value {
            font-size: 16px;
            font-weight: bold;
            color: #e0e0e0;
        }
        .dashboard-item .value.cash { color: #9d4edd; }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }
        .status-dot.connected { background: #22c55e; }
        .dashboard-item .value.api { color: #9d4edd; cursor: pointer; }
        .dashboard-item .value.api:hover { text-decoration: underline; }
        .api-dropdown { position: relative; }
        .api-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #0a0a0f;
            border: 1px solid #2d2d44;
            border-radius: 6px;
            padding: 10px;
            z-index: 100;
            min-width: 200px;
            margin-top: 5px;
        }
        .api-dropdown-menu.open { display: block; }
        .api-dropdown-menu .setting-inline { margin-bottom: 8px; }
        .api-dropdown-menu .setting-inline:last-child { margin-bottom: 0; }

        .market-picker {
            background: #0a0a0f;
            border: 1px solid #2d2d44;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .market-picker h3 { margin-bottom: 10px; color: #888; }
        .market-picker select {
            background: #000;
            border: 1px solid #2d2d44;
            color: #e0e0e0;
            padding: 8px 10px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            margin-right: 10px;
        }
        .market-picker select:focus { outline: none; border-color: #9d4edd; }
        .market-list {
            margin-top: 12px;
            display: none;
        }
        .market-list.visible { display: block; }
        .market-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #2d2d44;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .market-item:hover { border-color: #9d4edd; }
        .market-item-info { flex: 1; }
        .market-item-teams { font-weight: bold; color: #e0e0e0; }
        .market-item-details { font-size: 12px; color: #888; margin-top: 4px; }
        .market-item-odds { text-align: right; }
        .market-item-theo { color: #9d4edd; font-weight: bold; }
        .market-item-fair { font-size: 12px; color: #888; }
        .market-list-loading { color: #888; font-style: italic; }
        .market-list-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #2d2d44;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: #0a0a0f;
            border: 1px solid #9d4edd;
            border-radius: 8px;
            padding: 20px;
            min-width: 300px;
        }
        .modal h3 { color: #9d4edd; margin-bottom: 15px; }
        .modal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .modal-row label { color: #888; }
        .modal-row input {
            background: #000;
            border: 1px solid #2d2d44;
            color: #e0e0e0;
            padding: 8px 10px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 13px;
            width: 80px;
            text-align: center;
        }
        .modal-row input:focus { outline: none; border-color: #9d4edd; }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Enhanced fills section */
        .fills {
            background: #0a0a0f;
            border: 2px solid #2d2d44;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .fills.has-fills { border-color: #9d4edd; }
        .fills h3 { margin-bottom: 10px; color: #9d4edd; font-size: 16px; }
        .fill-list {
            max-height: 150px;
            overflow-y: auto;
        }
        .fill {
            padding: 8px 10px;
            border-radius: 4px;
            background: #1a1a24;
            margin-bottom: 6px;
            display: flex;
            gap: 15px;
            font-size: 13px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fill:last-child { margin-bottom: 0; }
        .fill-time { color: #888; }
        .fill-details { color: #e0e0e0; flex: 1; }
        .fill.complete { background: #1a2d1a; border-left: 3px solid #22c55e; }
        .fill-profit { color: #22c55e; font-weight: bold; }
        .no-fills { color: #666; font-style: italic; padding: 10px 0; }

        /* Fill notification */
        .fill-notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #9d4edd;
            color: #000;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }
        .fill-notification.visible { display: block; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Settings bar */
        .settings-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #0a0a0f;
            border: 1px solid #2d2d44;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .settings-label { color: #888; }
        .setting-inline {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .setting-inline label { color: #666; }
        .setting-inline input {
            background: #000;
            border: 1px solid #2d2d44;
            color: #e0e0e0;
            padding: 4px 6px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 12px;
            width: 50px;
            text-align: center;
        }
        .setting-inline input:focus { outline: none; border-color: #9d4edd; }
        .setting-inline span { color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <div class="dashboard-item">
            <div class="status-dot" id="status-dot"></div>
            <span class="value" id="connection-text">disconnected</span>
        </div>
        <div class="dashboard-item">
            <label>cash</label>
            <span class="value cash">$<span id="balance">0.00</span></span>
        </div>
        <div class="dashboard-item api-dropdown">
            <label>settings</label>
            <span class="value api" id="api-rate" onclick="toggleApiDropdown()">⚙</span>
            <div class="api-dropdown-menu" id="api-dropdown-menu">
                <div class="setting-inline">
                    <label>check</label>
                    <input type="number" id="setting-check-interval" step="0.5" min="0.5" value="2.0" onchange="updateGlobalSettings()">
                    <span>s</span>
                </div>
                <div class="setting-inline">
                    <label>ceiling reset</label>
                    <input type="number" id="setting-sticky-reset" step="1" min="1" value="10" onchange="updateGlobalSettings()">
                    <span>s</span>
                </div>
                <div class="setting-inline">
                    <label>overbid wait</label>
                    <input type="number" id="setting-overbid-delay" step="1" min="1" value="10" onchange="updateGlobalSettings()">
                    <span>s</span>
                </div>
            </div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="primary" onclick="startAll()" style="padding: 6px 8px;">start all</button>
            <button class="stop" onclick="cancelAll()" style="padding: 6px 8px;">stop all</button>
            <button class="secondary" onclick="removeAll()" style="padding: 6px 8px;">remove all</button>
        </div>
    </div>

    <div class="fills" id="fills-container">
        <h3>recent fills <button id="toggle-fills" onclick="toggleFills()" style="display:none; margin-left: 10px; padding: 2px 8px; font-size: 12px; cursor: pointer;">see more</button></h3>
        <div class="fill-list" id="fills">
            <div class="no-fills">no fills yet</div>
        </div>
    </div>

    <div class="fills" id="pnl-summary-container">
        <h3>P&L Summary
            <select id="pnl-period" onchange="loadPnlSummary()" style="margin-left: 10px; background: #000; border: 1px solid #2d2d44; color: #e0e0e0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
            </select>
        </h3>
        <div id="pnl-summary-table" style="margin-top: 10px;">
            <div class="no-fills">Loading...</div>
        </div>
    </div>

    <div class="market-picker">
        <h3>find markets</h3>
        <select id="market-type" onchange="onMarketTypeChange()">
            <option value="">select market type...</option>
            <option value="lacrosse">Men's Lacrosse</option>
            <option value="boxing">Boxing</option>
        </select>
        <button onclick="refreshMarkets()" class="secondary">refresh</button>
        <div class="market-list" id="market-list">
            <!-- Markets will be rendered here -->
        </div>
        <div class="market-list-actions" id="market-list-actions" style="display: none;">
            <button onclick="showAddAllModal()">add all markets</button>
        </div>
    </div>

    <div class="controls">
        <h3>add match</h3>
        <div class="form-row">
            <div class="form-group">
                <label>ticker a</label>
                <input type="text" id="ticker_a" class="medium" placeholder="KXCS2GAME-26FEB15R2BHE-R2">
            </div>
            <div class="form-group">
                <label>ticker b</label>
                <input type="text" id="ticker_b" class="medium" placeholder="KXCS2GAME-26FEB15R2BHE-BHE">
            </div>
            <div class="form-group">
                <label>odds a</label>
                <input type="number" id="odds_a" class="short" step="0.01" placeholder="1.80">
            </div>
            <div class="form-group">
                <label>odds b</label>
                <input type="number" id="odds_b" class="short" step="0.01" placeholder="2.00">
            </div>
            <div class="form-group">
                <label>edge</label>
                <input type="number" id="edge" class="short" step="0.1" value="2.5">
            </div>
            <div class="form-group">
                <label>contracts</label>
                <input type="number" id="contracts" class="short" value="5">
            </div>
            <div class="form-group">
                <label>inv max</label>
                <input type="number" id="inventory_max" class="short" value="15">
            </div>
            <button onclick="addMatch(this)">add</button>
        </div>
    </div>

    <div class="matches" id="matches">
        <!-- Matches will be rendered here -->
    </div>
    <div class="fill-notification" id="fill-notification"></div>

    <div class="modal-overlay" id="add-all-modal">
        <div class="modal">
            <h3>add all markets</h3>
            <div class="modal-row">
                <label>edge</label>
                <input type="number" id="modal-edge" step="0.1" value="2.5">
            </div>
            <div class="modal-row">
                <label>contracts</label>
                <input type="number" id="modal-contracts" value="5">
            </div>
            <div class="modal-row">
                <label>inv max</label>
                <input type="number" id="modal-inventory-max" value="15">
            </div>
            <div class="modal-row">
                <label>markets</label>
                <span id="modal-market-count">0</span>
            </div>
            <div class="modal-actions">
                <button class="secondary" onclick="hideAddAllModal()">cancel</button>
                <button onclick="addAllMarkets()">add all</button>
                <button class="primary" onclick="addAndStartAllMarkets()">add & start all</button>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let state = { matches: [], fills: [], balance: 0, settings: {} };
        let previousFillCount = 0;
        let showAllFills = false;
        let lastFillsJson = '';
        let marketCache = {};  // Cache for market data by type
        let settingsInitialized = false;
        let collapsedCategories = {};  // Track which categories are collapsed

        function toggleCategory(category) {
            collapsedCategories[category] = !collapsedCategories[category];
            render();
        }

        function escapeHtml(str) {
            return str.replace(/'/g, "\\'");
        }

        function toggleApiDropdown() {
            const menu = document.getElementById('api-dropdown-menu');
            menu.classList.toggle('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.querySelector('.api-dropdown');
            const menu = document.getElementById('api-dropdown-menu');
            if (dropdown && menu && !dropdown.contains(e.target)) {
                menu.classList.remove('open');
            }
        });

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws`);

            ws.onopen = () => {
                document.getElementById('status-dot').classList.add('connected');
                document.getElementById('connection-text').textContent = 'connected';
            };

            ws.onclose = () => {
                document.getElementById('status-dot').classList.remove('connected');
                document.getElementById('connection-text').textContent = 'disconnected';
                setTimeout(connect, 2000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'state') {
                    state = data;
                    render();
                }
            };
        }

        function renderOrder(order, isActive) {
            if (!isActive) {
                return `<span class="orderbook-our inactive">stopped</span>`;
            } else if (order.price && order.reason && order.reason.includes('rebal')) {
                return `<span class="orderbook-our rebal">bid ${order.price}c (-ev rebal)</span>`;
            } else if (order.price && order.reason === 'at ceiling') {
                return `<span class="orderbook-our active">bid ${order.price}c (ceiling)</span>`;
            } else if (order.price) {
                return `<span class="orderbook-our active">bid ${order.price}c</span>`;
            } else if (order.reason) {
                return `<span class="orderbook-our inactive">${order.reason}</span>`;
            } else {
                return `<span class="orderbook-our inactive">-</span>`;
            }
        }

        function render() {
            document.getElementById('balance').textContent = state.balance.toFixed(2);

            // Sync settings inputs (only on first load)
            if (state.settings && !settingsInitialized) {
                document.getElementById('setting-check-interval').value = state.settings.check_interval || 2;
                document.getElementById('setting-sticky-reset').value = state.settings.sticky_reset_secs || 10;
                document.getElementById('setting-overbid-delay').value = state.settings.overbid_cancel_delay || 10;
                settingsInitialized = true;
            }

            // Group matches by category
            const categorized = {};
            state.matches.forEach(m => {
                const cat = m.category || 'Other';
                if (!categorized[cat]) categorized[cat] = [];
                categorized[cat].push(m);
            });

            // Render matches grouped by category
            const matchesEl = document.getElementById('matches');

            // Skip re-render if user is editing an input (prevents losing focus)
            const activeEl = document.activeElement;
            if (activeEl && activeEl.tagName === 'INPUT' && matchesEl.contains(activeEl)) {
                return; // Don't re-render while editing
            }

            matchesEl.innerHTML = Object.entries(categorized).map(([category, catMatches]) => `
                <div class="category-section">
                    <div class="category-header ${collapsedCategories[category] ? 'collapsed' : ''}" onclick="toggleCategory('${escapeHtml(category)}')">
                        <span class="category-toggle">▼</span>
                        <span class="category-name">${category}</span>
                        <span class="category-count">(${catMatches.length})</span>
                    </div>
                    <div class="category-matches ${collapsedCategories[category] ? 'collapsed' : ''}">
                        ${catMatches.map(m => `
                            <div class="match ${m.active ? 'active' : ''}">
                                <div class="match-header">
                                    <div class="match-title">
                                        <div class="status-dot ${m.active ? 'active' : ''}"></div>
                                        <a class="match-name" href="${m.market_url || '#'}" target="_blank" ${m.market_url ? '' : 'onclick="return false;"'}>${m.name}</a>
                                        ${m.missed_trade_time ? `<span class="missed-trade" title="${m.missed_trade_desc}">❌ ${m.missed_trade_time}</span>` : ''}
                                    </div>
                                    <div class="match-actions">
                                        ${m.active
                                            ? `<button class="stop" onclick="stopMatch('${m.id}', this)">stop</button>`
                                            : `<button onclick="startMatch('${m.id}', this)">start</button>`
                                        }
                                        <button class="secondary" onclick="refreshOdds('${m.id}', this)" title="Refresh odds from Odds API">↻</button>
                                        <button class="secondary" onclick="removeMatch('${m.id}', this)">remove</button>
                                    </div>
                                </div>
                                <div class="orderbooks">
                                    <div class="orderbook">
                                        <div class="orderbook-header">
                                            <span class="orderbook-label">${m.market_a.label} <span class="orderbook-spread">${m.market_a.best_bid}@${m.market_a.best_ask}</span></span>
                                            <span class="orderbook-theo">theo ${m.market_a.theo.toFixed(1)}c</span>
                                        </div>
                                        <div class="orderbook-row">
                                            <span class="orderbook-side">yes</span>
                                            <span class="orderbook-best">${m.market_a.second_bid || 0}-${m.market_a.best_bid}</span>
                                            ${renderOrder(m.orders.a_yes, m.active)}
                                        </div>
                                        <div class="orderbook-row">
                                            <span class="orderbook-side">no</span>
                                            <span class="orderbook-best">${100 - (m.market_a.second_ask || 100)}-${100 - m.market_a.best_ask}</span>
                                            ${renderOrder(m.orders.a_no, m.active)}
                                        </div>
                                    </div>
                                    <div class="orderbook">
                                        <div class="orderbook-header">
                                            <span class="orderbook-label">${m.market_b.label} <span class="orderbook-spread">${m.market_b.best_bid}@${m.market_b.best_ask}</span></span>
                                            <span class="orderbook-theo">theo ${m.market_b.theo.toFixed(1)}c</span>
                                        </div>
                                        <div class="orderbook-row">
                                            <span class="orderbook-side">yes</span>
                                            <span class="orderbook-best">${m.market_b.second_bid || 0}-${m.market_b.best_bid}</span>
                                            ${renderOrder(m.orders.b_yes, m.active)}
                                        </div>
                                        <div class="orderbook-row">
                                            <span class="orderbook-side">no</span>
                                            <span class="orderbook-best">${100 - (m.market_b.second_ask || 100)}-${100 - m.market_b.best_ask}</span>
                                            ${renderOrder(m.orders.b_no, m.active)}
                                        </div>
                                    </div>
                                </div>
                                <div class="match-footer">
                                    <span class="inventory ${Math.abs(m.inventory) >= m.inventory_max ? 'overexposed' : ''}">
                                        ${m.inventory === 0 ? 'neutral' : m.inventory > 0 ? `long ${m.market_a.label} (${m.inventory})` : `long ${m.market_b.label} (${Math.abs(m.inventory)})`}
                                    </span>
                                    <div class="match-settings">
                                        <div class="setting-group">
                                            <label>odds</label>
                                            <input type="number" step="0.01" value="${m.odds_a}" class="wide" onchange="updateSettings('${m.id}', 'odds_a', this.value)">
                                            <input type="number" step="0.01" value="${m.odds_b}" class="wide" onchange="updateSettings('${m.id}', 'odds_b', this.value)">
                                        </div>
                                        <div class="setting-group">
                                            <label>edge</label>
                                            <input type="number" step="0.1" value="${m.edge}" onchange="updateSettings('${m.id}', 'edge', this.value)">
                                        </div>
                                        <div class="setting-group">
                                            <label>size</label>
                                            <input type="number" value="${m.contracts}" onchange="updateSettings('${m.id}', 'contracts', this.value)">
                                        </div>
                                        <div class="setting-group">
                                            <label>max</label>
                                            <input type="number" value="${m.inventory_max}" onchange="updateSettings('${m.id}', 'inventory_max', this.value)">
                                        </div>
                                    </div>
                                </div>
                                ${m.pnl && (m.pnl.arb_profit !== 0 || m.pnl.leftover_a > 0 || m.pnl.leftover_b > 0) ? `
                                <div class="pnl-section" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #2d2d44; font-size: 11px;">
                                    <div style="display: flex; justify-content: space-between; color: #888;">
                                        <span>Arb: <span style="color: ${m.pnl.arb_profit >= 0 ? '#22c55e' : '#dc3545'}">$${(m.pnl.arb_profit / 100).toFixed(2)}</span></span>
                                        <span>Fees: <span style="color: #dc3545">-$${(m.pnl.fees / 100).toFixed(2)}</span></span>
                                        <span>Net: <span style="color: ${(m.pnl.arb_profit - m.pnl.fees) >= 0 ? '#22c55e' : '#dc3545'}">$${((m.pnl.arb_profit - m.pnl.fees) / 100).toFixed(2)}</span></span>
                                    </div>
                                    ${m.pnl.leftover_a > 0 || m.pnl.leftover_b > 0 ? `
                                    <div style="color: #888; margin-top: 4px;">
                                        Leftover: ${m.pnl.leftover_a} ${m.market_a.label} / ${m.pnl.leftover_b} ${m.market_b.label} (EV: $${(m.pnl.leftover_ev / 100).toFixed(2)})
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Render fills - only update if changed
            const fillsEl = document.getElementById('fills');
            const fillsContainer = document.getElementById('fills-container');
            const toggleBtn = document.getElementById('toggle-fills');
            const currentFillsJson = JSON.stringify(state.fills);

            if (state.fills.length > 0) {
                fillsContainer.classList.add('has-fills');

                // Show/hide toggle button
                if (state.fills.length > 3) {
                    toggleBtn.style.display = 'inline';
                    toggleBtn.textContent = showAllFills ? 'see less' : `see more (${state.fills.length})`;
                } else {
                    toggleBtn.style.display = 'none';
                }

                // Only re-render if fills changed
                if (currentFillsJson !== lastFillsJson) {
                    const displayFills = showAllFills ? state.fills : state.fills.slice(-3);
                    fillsEl.innerHTML = displayFills.slice().reverse().map(f => `
                        <div class="fill ${f.complete_set ? 'complete' : ''}">
                            <span class="fill-time">${f.timestamp}</span>
                            <span class="fill-details">
                                [${f.match_id}] ${f.side} ${f.count}@${f.price}c
                            </span>
                            ${f.complete_set ? `<span class="fill-profit">+${f.profit}c</span>` : ''}
                        </div>
                    `).join('');
                    lastFillsJson = currentFillsJson;
                }

                // Show notification for new fills
                if (state.fills.length > previousFillCount && previousFillCount > 0) {
                    const newFill = state.fills[state.fills.length - 1];
                    showFillNotification(newFill);
                }
                previousFillCount = state.fills.length;
            } else {
                fillsContainer.classList.remove('has-fills');
                toggleBtn.style.display = 'none';
                fillsEl.innerHTML = '<div class="no-fills">no fills yet</div>';
            }
        }

        function toggleFills() {
            showAllFills = !showAllFills;
            lastFillsJson = '';  // Force re-render
            render();
        }

        function showFillNotification(fill) {
            const notif = document.getElementById('fill-notification');
            notif.textContent = `FILL: ${fill.side} ${fill.count}@${fill.price}c`;
            notif.classList.add('visible');

            // Play sound (optional - browser may block)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp6fko+IgoB8fYOIjpKRjoqGgn18fICEiY2QkY+LhoJ9e3yAhIqOkZKQjYiDfnt7f4OJjpGTko+LhoF9e3+DiY6Rk5GPioWAfHt/g4mOkpOSj4qFgHx7f4OJjpKUko+KhYB8e3+DiY6SlJKPioV/fHt/g4mOkpSSj4qFf3x7f4OJjpKUko+KhX98e3+DiY6SlJKPioV/fHt/g4mOkpSSj4qFf3x7f4OJjpKUko+KhX98fH+DiY6SlJGPioV/fHx/g4mOkZSSj4qFf3x8f4OJjpGUko6KhX98fH+DiY6RlJKOioV/fHx/g4mOkZSSjoqFf3x8gIOJjpGUko6Jgn56');
                audio.volume = 0.3;
                audio.play();
            } catch (e) {}

            setTimeout(() => {
                notif.classList.remove('visible');
            }, 3000);
        }

        async function addMatch(btn) {
            const ticker_a = document.getElementById('ticker_a').value;
            const ticker_b = document.getElementById('ticker_b').value;
            const odds_a = parseFloat(document.getElementById('odds_a').value);
            const odds_b = parseFloat(document.getElementById('odds_b').value);
            const edge = parseFloat(document.getElementById('edge').value) || 2.5;
            const contracts = parseInt(document.getElementById('contracts').value) || 5;
            const inventory_max = parseInt(document.getElementById('inventory_max').value) || 15;

            if (!ticker_a || !ticker_b || !odds_a || !odds_b) {
                alert('please fill all fields');
                return;
            }

            // Show loading
            if (btn) { btn.disabled = true; btn.textContent = '...'; }

            const payload = { ticker_a, ticker_b, odds_a, odds_b, edge, contracts, inventory_max };
            if (selectedEventTime) {
                payload.event_time = selectedEventTime;
            }

            await fetch('/api/matches', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Clear ticker and odds inputs only
            document.getElementById('ticker_a').value = '';
            document.getElementById('ticker_b').value = '';
            document.getElementById('odds_a').value = '';
            document.getElementById('odds_b').value = '';
            selectedEventTime = null;  // Clear after use

            // Reset button
            if (btn) { btn.disabled = false; btn.textContent = 'add'; }
        }

        async function startMatch(id, btn) {
            // Optimistic update - prevent double-click
            const match = state.matches.find(m => m.id === id);
            if (match) match.active = true;
            render();

            await fetch(`/api/matches/${id}/start`, { method: 'POST' });
        }

        async function stopMatch(id, btn) {
            // Optimistic update - prevent double-click
            const match = state.matches.find(m => m.id === id);
            if (match) match.active = false;
            render();

            await fetch(`/api/matches/${id}/stop`, { method: 'POST' });
        }

        async function removeMatch(id, btn) {
            if (confirm('remove this match?')) {
                // Optimistic update
                state.matches = state.matches.filter(m => m.id !== id);
                render();

                await fetch(`/api/matches/${id}`, { method: 'DELETE' });
            }
        }

        async function refreshOdds(id, btn) {
            // Show loading
            const origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';

            const resp = await fetch(`/api/matches/${id}/refresh-odds`, { method: 'POST' });
            const data = await resp.json();

            btn.disabled = false;
            btn.textContent = origText;

            if (data.error) {
                alert('Refresh failed: ' + data.error);
            }
        }

        async function updateSettings(id, field, value) {
            const match = state.matches.find(m => m.id === id);
            if (!match) return;

            const payload = {};

            if (field === 'odds_a' || field === 'odds_b') {
                // For odds, send both values
                payload.odds_a = field === 'odds_a' ? parseFloat(value) : match.odds_a;
                payload.odds_b = field === 'odds_b' ? parseFloat(value) : match.odds_b;
            } else if (field === 'edge') {
                payload.edge = parseFloat(value);
            } else if (field === 'contracts') {
                payload.contracts = parseInt(value);
            } else if (field === 'inventory_max') {
                payload.inventory_max = parseInt(value);
            }

            await fetch(`/api/matches/${id}/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Update local state immediately
            Object.assign(match, payload);

            // Blur input and re-render
            if (document.activeElement) document.activeElement.blur();
            renderState();
        }

        // Market picker functions
        let availableMarkets = [];

        async function onMarketTypeChange() {
            const type = document.getElementById('market-type').value;
            const listEl = document.getElementById('market-list');
            const actionsEl = document.getElementById('market-list-actions');

            if (!type) {
                listEl.classList.remove('visible');
                actionsEl.style.display = 'none';
                return;
            }

            // Use cache if available
            if (marketCache[type]) {
                availableMarkets = marketCache[type];
                renderMarketList();
                return;
            }

            // First time - fetch from API
            await refreshMarkets();
        }

        async function refreshMarkets() {
            const type = document.getElementById('market-type').value;
            const listEl = document.getElementById('market-list');

            if (!type) return;

            listEl.classList.add('visible');
            listEl.innerHTML = '<div class="market-list-loading">loading...</div>';

            try {
                let endpoint = '';
                if (type === 'lacrosse') {
                    endpoint = '/api/markets/lacrosse';
                } else if (type === 'boxing') {
                    endpoint = '/api/markets/boxing';
                }

                const resp = await fetch(endpoint);
                const data = await resp.json();
                availableMarkets = data.markets || [];

                // Cache the results
                marketCache[type] = availableMarkets;

                renderMarketList();
            } catch (e) {
                listEl.innerHTML = '<div class="market-list-loading">error loading markets</div>';
                document.getElementById('market-list-actions').style.display = 'none';
            }
        }

        function renderMarketList() {
            const listEl = document.getElementById('market-list');
            const actionsEl = document.getElementById('market-list-actions');

            listEl.classList.add('visible');

            if (availableMarkets.length === 0) {
                listEl.innerHTML = '<div class="market-list-loading">no markets found</div>';
                actionsEl.style.display = 'none';
                return;
            }

            listEl.innerHTML = availableMarkets.map((m, i) => `
                <div class="market-item" onclick="selectMarket(${i})">
                    <div class="market-item-info">
                        <div class="market-item-teams">${m.away_team} @ ${m.home_team}</div>
                        <div class="market-item-details">
                            ${m.commence_time.slice(0, 16).replace('T', ' ')} | ${m.bookmakers.join(', ')}
                        </div>
                    </div>
                    <div class="market-item-odds">
                        <div class="market-item-theo">${m.theo_a}c / ${m.theo_b}c</div>
                        <div class="market-item-fair">${m.odds_a.toFixed(2)} / ${m.odds_b.toFixed(2)}</div>
                    </div>
                </div>
            `).join('');

            actionsEl.style.display = 'block';
        }

        let selectedEventTime = null;  // Store commence_time from selected market

        function selectMarket(index) {
            const m = availableMarkets[index];
            if (!m) return;

            document.getElementById('ticker_a').value = m.ticker_a;
            document.getElementById('ticker_b').value = m.ticker_b;
            document.getElementById('odds_a').value = m.odds_a;
            document.getElementById('odds_b').value = m.odds_b;
            selectedEventTime = m.commence_time;  // Store for addMatch()

            // Scroll to the add match form
            document.querySelector('.controls').scrollIntoView({ behavior: 'smooth' });
        }

        function showAddAllModal() {
            document.getElementById('modal-market-count').textContent = availableMarkets.length;
            document.getElementById('modal-edge').value = document.getElementById('edge').value || '1.5';
            document.getElementById('modal-contracts').value = document.getElementById('contracts').value || '30';
            document.getElementById('modal-inventory-max').value = document.getElementById('inventory_max').value || '20';
            document.getElementById('add-all-modal').classList.add('visible');
        }

        function hideAddAllModal() {
            document.getElementById('add-all-modal').classList.remove('visible');
        }

        async function addAllMarkets() {
            const edge = parseFloat(document.getElementById('modal-edge').value) || 2.5;
            const contracts = parseInt(document.getElementById('modal-contracts').value) || 5;
            const inventory_max = parseInt(document.getElementById('modal-inventory-max').value) || 15;

            hideAddAllModal();

            // Use batch endpoint for parallel adds
            const configs = availableMarkets.map(m => ({
                ticker_a: m.ticker_a,
                ticker_b: m.ticker_b,
                odds_a: m.odds_a,
                odds_b: m.odds_b,
                edge,
                contracts,
                inventory_max,
                event_time: m.commence_time
            }));

            await fetch('/api/matches/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configs)
            });
        }

        async function addAndStartAllMarkets() {
            const edge = parseFloat(document.getElementById('modal-edge').value) || 2.5;
            const contracts = parseInt(document.getElementById('modal-contracts').value) || 5;
            const inventory_max = parseInt(document.getElementById('modal-inventory-max').value) || 15;

            hideAddAllModal();

            // Use batch endpoint for parallel adds
            const configs = availableMarkets.map(m => ({
                ticker_a: m.ticker_a,
                ticker_b: m.ticker_b,
                odds_a: m.odds_a,
                odds_b: m.odds_b,
                edge,
                contracts,
                inventory_max,
                event_time: m.commence_time
            }));

            await fetch('/api/matches/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configs)
            });

            // Start all using parallel endpoint
            await fetch('/api/matches/start-all', { method: 'POST' });
        }

        async function updateGlobalSettings() {
            const check_interval = parseFloat(document.getElementById('setting-check-interval').value);
            const sticky_reset_secs = parseFloat(document.getElementById('setting-sticky-reset').value);
            const overbid_cancel_delay = parseFloat(document.getElementById('setting-overbid-delay').value);

            await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ check_interval, sticky_reset_secs, overbid_cancel_delay })
            });
        }

        async function cancelAll() {
            if (!confirm('Cancel all orders?')) return;
            const resp = await fetch('/api/kill', { method: 'POST' });
            const data = await resp.json();
            alert(`Cancelled ${data.cancelled} orders`);
        }

        async function removeAll() {
            if (!confirm('Remove all markets?')) return;
            // Optimistic update
            state.matches = [];
            render();
            await fetch('/api/matches/all', { method: 'DELETE' });
        }

        async function startAll() {
            const inactiveMatches = state.matches.filter(m => !m.active);
            if (inactiveMatches.length === 0) {
                alert('No inactive matches to start');
                return;
            }
            // Optimistic update
            inactiveMatches.forEach(m => m.active = true);
            render();
            // Use parallel start endpoint
            await fetch('/api/matches/start-all', { method: 'POST' });
        }

        // P&L Summary functions
        async function loadPnlSummary() {
            const period = document.getElementById('pnl-period').value;
            const tableEl = document.getElementById('pnl-summary-table');

            try {
                const resp = await fetch(`/api/pnl/summary?period=${period}`);
                const data = await resp.json();

                if (!data.summary || data.summary.length === 0) {
                    tableEl.innerHTML = '<div class="no-fills">No P&L data yet.</div>';
                    return;
                }

                let html = `
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <thead>
                            <tr style="color: #888; text-align: left;">
                                <th style="padding: 6px;">Period</th>
                                <th style="padding: 6px;">Arb</th>
                                <th style="padding: 6px;">Fees</th>
                                <th style="padding: 6px;">Hedge</th>
                                <th style="padding: 6px;">Net</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const row of data.summary) {
                    const netColor = row.net_profit >= 0 ? '#22c55e' : '#dc3545';
                    html += `
                        <tr style="border-top: 1px solid #2d2d44;">
                            <td style="padding: 6px;">${row.period}</td>
                            <td style="padding: 6px; color: ${row.arb_profit >= 0 ? '#22c55e' : '#dc3545'}">$${(row.arb_profit / 100).toFixed(2)}</td>
                            <td style="padding: 6px; color: #dc3545">-$${(row.fees / 100).toFixed(2)}</td>
                            <td style="padding: 6px; color: ${row.hedge_pnl >= 0 ? '#22c55e' : '#dc3545'}">$${row.hedge_pnl.toFixed(2)}</td>
                            <td style="padding: 6px; color: ${netColor}">$${(row.net_profit / 100).toFixed(2)}</td>
                        </tr>
                    `;
                }

                html += '</tbody></table>';
                tableEl.innerHTML = html;
            } catch (e) {
                tableEl.innerHTML = '<div class="no-fills">Error loading P&L data.</div>';
            }
        }

        // Initial connection
        connect();
        // Load P&L summary on page load
        loadPnlSummary();
    </script>
</body>
</html>
